/*
 MIT.
*/
function Chain(a){if(!(this instanceof Chain))return new Chain(a);this.$elements=a||[];this.$listeners=[];this.$result=void 0;this.$results=[];this.$running=!1}Chain.type={SYNC:0,ASYNC:1,CHAIN:2};Chain.prototype.then=function(a){var b,c;a instanceof Array||(a=[a]);for(b=0;b<a.length;b++)c={type:Chain.type.SYNC,fn:a[b]},this.$elements.push(c);return this};
Chain.prototype.defer=function(a){var b,c;a instanceof Array||(a=[a]);for(b=0;b<a.length;b++)c={type:Chain.type.ASYNC,fn:a[b]},this.$elements.push(c);return this};Chain.prototype.when=function(a){var b,c=this.$elements;b=c[c.length-1];var d=Chain.type.CHAIN;a instanceof Array||(a=[a]);for(i=0;i<a.length;i++)(b=c[c.length-1])&&b.type==d||0<i?b.chains.push(a[i]):(b={type:d,chains:[a[i]]},this.$elements.push(b));return this};
Chain.prototype.$callback=function(a,b){var c=this;return function(d){c.$result=d;c.$next(a,b)}};Chain.handler={};Chain.handler[Chain.type.SYNC]=function(a,b,c,d){a.$result=b.fn(a.$result);a.$next(c,d)};Chain.handler[Chain.type.ASYNC]=function(a,b,c,d){b.fn(a.$result,a.$callback(c,d))};
Chain.handler[Chain.type.CHAIN]=function(a,b,c,d){function f(e){return function(f){a.$results[e]=f;++g===b.chains.length&&(a.$result=a.$results,a.$results=[],a.$next(c,d))}}var e,g=0;a.$result&&a.$results.push(a.$result);for(e=0;e<b.chains.length;e++)b.chains[e].end(f(e))};
Chain.prototype.$done=function(a){this.$results.length&&this.$result&&(this.$results.push(this.$result),this.$result=this.$results,this.$results=[]);a(this.$result);this.$running=!1;for(a=0;a<this.$listeners.length;a++)this.$listeners[a](this.$result);this.$listeners=[]};Chain.prototype.$next=function(a,b){var c=this.$elements[a],d=this.constructor.handler;if(a++>=this.$elements.length)return this.$done(b);d[c.type](this,c,a,b)};Chain.prototype.$noop=function(){};
Chain.prototype.$run=function(a){a&&"function"==typeof a||(a=this.$noop);this.$running?this.$listeners.push(a):(this.$running=!0,this.$next(0,a))};Chain.prototype.end=function(a,b){b||void 0===this.$result?this.$run(a):a(this.$result);return this};